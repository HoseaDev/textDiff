# 邮箱验证码功能测试指南

## 准备工作

### 1. 配置SMTP服务器

编辑 `backend/.env` 文件,填入您的SMTP信息:

```env
# 示例: 使用Gmail
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password  # Gmail需要使用应用专用密码
SMTP_FROM_EMAIL=noreply@textdiff.com
SMTP_FROM_NAME=TextDiff
SMTP_USE_TLS=True

# 验证码配置
VERIFICATION_CODE_EXPIRE_MINUTES=5
VERIFICATION_CODE_LENGTH=6
```

**获取Gmail应用专用密码:**
1. 登录Gmail账号
2. 前往 https://myaccount.google.com/security
3. 开启两步验证
4. 创建应用专用密码
5. 将密码填入SMTP_PASSWORD

### 2. 启动服务

```bash
# 终端1: 启动后端
cd backend
python -m app.main

# 终端2: 启动前端
cd frontend
npm run dev
```

## 测试流程

### 测试1: 发送验证码API

**使用curl测试:**

```bash
curl -X POST http://localhost:8000/api/verification/send \
  -H "Content-Type: application/json" \
  -d '{
    "email": "your-test-email@example.com",
    "purpose": "register"
  }'
```

**预期结果:**
```json
{
  "success": true,
  "message": "验证码已发送,请查收邮件",
  "code_id": "some-uuid"
}
```

**验证:**
- ✅ 检查邮箱是否收到验证码
- ✅ 验证码是6位数字
- ✅ 邮件格式美观(渐变色设计)

### 测试2: 防机器人机制

**测试同一邮箱60秒限制:**

```bash
# 第一次发送 - 应该成功
curl -X POST http://localhost:8000/api/verification/send \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "purpose": "register"}'

# 立即第二次发送 - 应该被拦截
curl -X POST http://localhost:8000/api/verification/send \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "purpose": "register"}'
```

**预期结果(第二次):**
```json
{
  "detail": "发送过于频繁,请 XX 秒后重试"
}
```
HTTP状态码: 429

### 测试3: 验证验证码API

**使用curl测试:**

```bash
curl -X POST http://localhost:8000/api/verification/verify \
  -H "Content-Type: application/json" \
  -d '{
    "email": "your-test-email@example.com",
    "code": "123456",
    "purpose": "register"
  }'
```

**预期结果(正确验证码):**
```json
{
  "success": true,
  "message": "验证成功"
}
```

**预期结果(错误验证码):**
```json
{
  "detail": "验证码无效或已使用"
}
```
HTTP状态码: 400

### 测试4: 前端完整注册流程

1. **打开注册页面**
   - 访问: http://localhost:5173/register

2. **填写注册信息**
   - 输入用户名: testuser
   - 输入邮箱: your-test-email@example.com
   - 点击邮箱输入框外侧,触发邮箱验证

3. **获取验证码**
   - 点击"获取验证码"按钮
   - 观察按钮变为"60秒后重试"
   - 检查是否显示"验证码已发送,请查收邮件"

4. **查收邮件**
   - 打开邮箱查看验证码
   - 验证邮件格式美观

5. **输入验证码**
   - 在验证码输入框输入6位数字

6. **完成注册**
   - 输入密码: Password123
   - 确认密码: Password123
   - 点击"注册"按钮
   - 观察是否成功跳转到首页

### 测试5: 错误场景

#### 5.1 无效邮箱

- 输入邮箱: invalid-email
- 点击"获取验证码"
- 预期: 按钮保持禁用状态

#### 5.2 错误验证码

- 正常获取验证码
- 输入错误的验证码: 999999
- 点击注册
- 预期: 显示"验证码无效或已使用"

#### 5.3 过期验证码

- 获取验证码后等待6分钟
- 输入正确的验证码
- 点击注册
- 预期: 显示"验证码已过期,请重新获取"

#### 5.4 重复使用验证码

- 使用验证码注册成功
- 使用同一验证码再次尝试注册
- 预期: 显示"验证码无效或已使用"

### 测试6: 倒计时功能

1. **正常倒计时**
   - 点击"获取验证码"
   - 观察倒计时从60开始递减
   - 倒计时期间按钮显示"XX秒后重试"
   - 倒计时期间按钮禁用

2. **倒计时结束**
   - 等待60秒
   - 按钮恢复为"获取验证码"
   - 按钮可以再次点击

3. **页面刷新**
   - 倒计时进行中时刷新页面
   - 倒计时重置
   - 可以再次发送(但可能触发后端频率限制)

### 测试7: UI/UX测试

#### 7.1 响应式布局

- [ ] 桌面端(1920x1080)布局正常
- [ ] 平板端(768x1024)布局正常
- [ ] 手机端(375x667)布局正常
- [ ] 验证码输入框和按钮对齐

#### 7.2 交互反馈

- [ ] 按钮hover效果正常
- [ ] 按钮禁用状态视觉明确
- [ ] 成功提示显示为绿色
- [ ] 错误提示显示为红色
- [ ] 倒计时数字动态更新

#### 7.3 可访问性

- [ ] Tab键可以正确导航
- [ ] 表单标签关联正确
- [ ] 必填字段有*标记
- [ ] placeholder文字清晰

## 性能测试

### 测试8: 并发测试

使用ApacheBench或类似工具:

```bash
# 测试发送验证码接口的并发性能
ab -n 100 -c 10 -p verify.json -T application/json \
  http://localhost:8000/api/verification/send
```

**verify.json内容:**
```json
{
  "email": "load-test@example.com",
  "purpose": "register"
}
```

**预期:**
- 大部分请求应该被频率限制拦截
- 服务器不应崩溃
- 响应时间合理

## 安全测试

### 测试9: SQL注入测试

```bash
curl -X POST http://localhost:8000/api/verification/send \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com; DROP TABLE users;--",
    "purpose": "register"
  }'
```

**预期:**
- 请求被安全处理
- 没有SQL注入成功

### 测试10: XSS测试

```bash
curl -X POST http://localhost:8000/api/verification/send \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com<script>alert(1)</script>",
    "purpose": "register"
  }'
```

**预期:**
- 邮箱验证失败
- 没有执行脚本

## 数据库验证

### 测试11: 验证码记录

连接MySQL数据库查看验证码记录:

```sql
SELECT * FROM verification_codes
WHERE email = 'your-test-email@example.com'
ORDER BY created_at DESC
LIMIT 5;
```

**验证字段:**
- ✅ id: UUID格式
- ✅ email: 正确的邮箱
- ✅ code: 6位数字
- ✅ purpose: 'register'
- ✅ is_used: false → true (使用后)
- ✅ expires_at: created_at + 5分钟
- ✅ ip_address: 记录了客户端IP

## 日志检查

### 测试12: 后端日志

查看后端控制台输出:

**成功发送:**
```
INFO: Email sent successfully to test@example.com
```

**发送失败:**
```
ERROR: Failed to send email to test@example.com: <error details>
```

**频率限制触发:**
```
INFO: Rate limit hit for test@example.com from 127.0.0.1
```

## 测试清单总结

### 功能测试
- [ ] API发送验证码成功
- [ ] 收到验证码邮件
- [ ] 验证码验证成功
- [ ] 验证码验证失败提示正确
- [ ] 完整注册流程成功

### 防护机制
- [ ] 60秒频率限制生效
- [ ] IP频率限制生效
- [ ] 验证码过期机制生效
- [ ] 一次性使用机制生效

### UI/UX
- [ ] 倒计时功能正常
- [ ] 按钮状态正确
- [ ] 提示信息清晰
- [ ] 响应式布局正常

### 安全性
- [ ] 邮箱格式验证
- [ ] SQL注入防护
- [ ] XSS防护
- [ ] HTTPS传输(生产环境)

## 常见问题排查

### 问题1: 收不到邮件

**排查步骤:**
1. 检查SMTP配置是否正确
2. 查看后端日志是否有错误
3. 检查垃圾邮件文件夹
4. 尝试使用不同的邮箱
5. 测试SMTP连接:
```python
import smtplib
server = smtplib.SMTP('smtp.gmail.com', 587)
server.starttls()
server.login('your-email', 'your-password')
print("SMTP connection successful!")
```

### 问题2: 验证码验证失败

**排查步骤:**
1. 确认验证码未过期(5分钟内)
2. 检查验证码是否正确(区分大小写)
3. 查看数据库验证码记录
4. 检查后端日志

### 问题3: 倒计时不工作

**排查步骤:**
1. 打开浏览器开发者工具console
2. 检查是否有JavaScript错误
3. 确认定时器正确启动
4. 检查组件是否正确卸载清理

## 生产环境检查

部署到生产环境前的最终检查:

- [ ] SMTP配置使用生产环境凭证
- [ ] SECRET_KEY已更改为随机值
- [ ] DEBUG=False
- [ ] HTTPS已启用
- [ ] 数据库定时清理任务已配置
- [ ] 监控和日志已配置
- [ ] 邮件模板中的链接指向生产域名
- [ ] 验证码有效期合理(5-10分钟)
- [ ] 频率限制策略合理

## 测试报告模板

```
# 验证码功能测试报告

测试日期: 2025-10-21
测试人员: [Your Name]
测试环境: 开发环境

## 测试结果

### 功能测试 (X/5 通过)
- [ ] 发送验证码
- [ ] 验证验证码
- [ ] 完整注册流程
- [ ] 错误处理
- [ ] 倒计时功能

### 安全测试 (X/4 通过)
- [ ] 频率限制
- [ ] 验证码过期
- [ ] SQL注入防护
- [ ] XSS防护

### UI/UX测试 (X/3 通过)
- [ ] 响应式布局
- [ ] 交互反馈
- [ ] 可访问性

## 发现的问题

1. [问题描述]
   - 严重程度: 高/中/低
   - 重现步骤: ...
   - 预期结果: ...
   - 实际结果: ...

## 建议

1. [改进建议]

## 结论

[测试通过/需要修复]
```

祝测试顺利! 🎉
