# 邮箱验证码功能说明

## 功能概述

已为TextDiff系统添加邮箱验证码注册功能,包含完整的SMTP邮件发送和防机器人机制。

## 后端实现

### 1. 配置SMTP服务

在 `backend/.env` 文件中配置您的SMTP服务器信息:

```env
# SMTP 邮件配置
SMTP_HOST=your-smtp-server.com      # SMTP服务器地址
SMTP_PORT=587                         # SMTP端口(587为TLS,465为SSL)
SMTP_USER=your-email@example.com     # SMTP用户名
SMTP_PASSWORD=your-smtp-password     # SMTP密码
SMTP_FROM_EMAIL=noreply@textdiff.com # 发件人邮箱
SMTP_FROM_NAME=TextDiff               # 发件人名称
SMTP_USE_TLS=True                     # 是否使用TLS

# 验证码配置
VERIFICATION_CODE_EXPIRE_MINUTES=5    # 验证码有效期(分钟)
VERIFICATION_CODE_LENGTH=6            # 验证码长度
```

### 2. 数据库表结构

已创建 `verification_codes` 表:

```sql
CREATE TABLE verification_codes (
    id VARCHAR(36) PRIMARY KEY,
    email VARCHAR(100) NOT NULL,
    code VARCHAR(10) NOT NULL,
    purpose VARCHAR(20) NOT NULL,  -- register/login/reset_password
    is_used BOOLEAN DEFAULT FALSE,
    expires_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP NULL,
    ip_address VARCHAR(45),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. API端点

#### 发送验证码

```http
POST /api/verification/send
Content-Type: application/json

{
  "email": "user@example.com",
  "purpose": "register"
}
```

**响应示例:**
```json
{
  "success": true,
  "message": "验证码已发送,请查收邮件",
  "code_id": "uuid-string"
}
```

#### 验证验证码

```http
POST /api/verification/verify
Content-Type: application/json

{
  "email": "user@example.com",
  "code": "123456",
  "purpose": "register"
}
```

#### 用户注册(需要验证码)

```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "user@example.com",
  "password": "password123",
  "verification_code": "123456",
  "full_name": "Test User"
}
```

### 4. 防机器人机制

系统实现了多层防护机制:

1. **频率限制 - 同一邮箱**: 60秒内只能发送1次验证码
2. **频率限制 - 同一IP**: 1分钟内最多发送3次
3. **频率限制 - 小时限制**: 同一邮箱1小时内最多发送10次
4. **验证码过期**: 5分钟后自动失效
5. **一次性使用**: 验证码验证后立即标记为已使用

### 5. 邮件模板

验证码邮件采用美观的HTML模板,包含:

- 品牌渐变色设计(紫色主题)
- 醒目的验证码显示
- 过期时间提示
- 安全提示信息
- 响应式布局

## 文件结构

```
backend/
├── app/
│   ├── api/routes/
│   │   ├── auth.py                    # 更新:添加验证码验证
│   │   └── verification.py            # 新增:验证码API
│   ├── models/
│   │   └── user.py                    # 更新:添加VerificationCode模型
│   ├── services/
│   │   ├── email_service.py           # 新增:邮件发送服务
│   │   └── verification_service.py    # 新增:验证码服务
│   ├── schemas/
│   │   └── user.py                    # 更新:UserCreate添加verification_code字段
│   └── core/
│       └── config.py                  # 更新:添加SMTP配置
├── migrations/
│   └── 002_add_verification_codes.sql # 新增:数据库迁移脚本
└── .env                                # 更新:SMTP配置
```

## 测试流程

### 1. 配置SMTP

修改 `backend/.env` 文件,填入您的SMTP服务器信息。

### 2. 重启后端服务器

```bash
cd backend
python -m app.main
```

### 3. 测试发送验证码

```bash
curl -X POST http://localhost:8000/api/verification/send \
  -H "Content-Type: application/json" \
  -d '{
    "email": "your-email@example.com",
    "purpose": "register"
  }'
```

### 4. 检查邮箱

查收验证码邮件,获取6位数验证码。

### 5. 测试注册

```bash
curl -X POST http://localhost:8000/api/verification/verify \
  -H "Content-Type: application/json" \
  -d '{
    "email": "your-email@example.com",
    "code": "123456",
    "purpose": "register"
  }'
```

## 安全特性

1. **密码加密**: bcrypt算法,自动处理72字节限制
2. **验证码加密存储**: 数据库中明文存储(因为需要邮件发送)
3. **IP地址记录**: 记录每次发送的IP,便于审计
4. **防暴力破解**: 验证码错误不会提示具体原因
5. **自动清理**: 过期验证码可配置定时清理(SQL注释中)

## 生产环境建议

1. **使用Redis**: 将频率限制缓存从内存改为Redis
   ```python
   # 在 verification_service.py 中
   # 替换 _rate_limit_cache 字典为 Redis
   ```

2. **启用定时清理**: 取消SQL中的事件注释
   ```sql
   -- 在 002_add_verification_codes.sql 中
   -- 取消 CREATE EVENT 的注释
   ```

3. **配置邮件队列**: 使用Celery等异步任务队列发送邮件

4. **添加监控**: 监控发送失败率和频率限制触发次数

5. **HTTPS强制**: 生产环境必须使用HTTPS

## 常见问题

### Q: 邮件发送失败怎么办?

A: 检查以下几点:
- SMTP服务器地址和端口是否正确
- 用户名和密码是否正确
- 是否需要开启"允许不够安全的应用访问"
- 防火墙是否阻止了SMTP端口
- 查看后端日志获取详细错误信息

### Q: 如何修改验证码长度和有效期?

A: 修改 `.env` 文件中的配置:
```env
VERIFICATION_CODE_EXPIRE_MINUTES=10  # 改为10分钟
VERIFICATION_CODE_LENGTH=8           # 改为8位
```

### Q: 如何测试邮件发送功能?

A: 可以使用临时邮箱服务或自己的邮箱进行测试。推荐使用:
- Gmail (需要开启应用专用密码)
- Mailgun (免费额度足够测试)
- SendGrid (免费额度)

### Q: 频率限制太严格,测试不方便怎么办?

A: 开发环境可以临时调整限制:
```python
# 在 verification_service.py 的 check_rate_limit 方法中
if seconds_since_last < 10:  # 改为10秒
    ...
if len(cache['send_times_minute']) >= 10:  # 改为10次
    ...
```

## 下一步

前端实现需要:

1. 在注册页面添加"发送验证码"按钮
2. 添加倒计时功能(60秒后才能重新发送)
3. 添加验证码输入框
4. 调用 `/api/verification/send` 和 `/api/auth/register` API
5. 处理各种错误情况(频率限制、验证码错误等)

详见前端实现部分的更新。
