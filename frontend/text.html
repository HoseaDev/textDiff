<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸ªäººç‰ˆç½‘é¡µæ–‡æœ¬å¯¹æ¯”å™¨ï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
  <style>
    :root {
      --bg: #0b0f14; --card: #121821; --muted: #6b7280; --text: #e5e7eb; --accent: #60a5fa;
      --add-bg: #063; --add: #78f3b1; --del-bg: #400; --del: #ff9aa2; --border: #222b36;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    textarea { width: 100%; min-height: 220px; resize: vertical; background: #0b1320; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
    label { color: var(--muted); font-size: 12px; display: inline-block; margin-bottom: 6px; }
    .btn { appearance: none; border: 1px solid var(--border); background: #0e1622; color: var(--text); padding: 8px 12px; border-radius: 10px; cursor: pointer; }
    .btn:hover { border-color: #2b3646; background: #101a28; }
    .btn.primary { border-color: #1e3a8a; background: #0b1430; color: #bfdbfe; }
    .btn.ghost { background: transparent; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    select, input[type="text"] { background: #0e1622; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
    .section-title { margin: 18px 0 10px; font-weight: 600; color: #cbd5e1; }
    .diff { white-space: pre-wrap; background: #0b1320; border: 1px solid var(--border); border-radius: 8px; padding: 12px; min-height: 160px; }
    .added { background: rgba(6, 94, 46, .5); color: var(--add); border-radius: 4px; padding: 1px 0; }
    .removed { background: rgba(128, 0, 0, .5); color: var(--del); text-decoration: line-through; border-radius: 4px; padding: 1px 0; }
    .unchanged { color: #cbd5e1; }
    .muted { color: var(--muted); }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .help { font-size: 12px; color: var(--muted); }
    .footer { margin-top: 16px; text-align: right; color: var(--muted); font-size: 12px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid var(--border); background:#0e1622; }
    .summary { display:flex; gap:10px; flex-wrap:wrap; }
    .hr { height:1px; background: var(--border); margin: 10px 0; border:0; }
  </style>
  <!-- jsdiff CDN -->
  <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>ä¸ªäººç‰ˆç½‘é¡µæ–‡æœ¬å¯¹æ¯”å™¨ï¼ˆæœ¬åœ°ä¿å­˜ / ç¦»çº¿å¯ç”¨ï¼‰</h1>
    <p class="help">ğŸ“ ç”¨é€”ï¼šå¯¹æ¯”ä»»æ„ä¸¤ä¸ªç‰ˆæœ¬ï¼Œçœ‹çœ‹â€œæ”¹åŠ¨äº†å“ªé‡Œâ€ã€‚æ‰€æœ‰ç‰ˆæœ¬ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ° <span class="pill">localStorage</span>ï¼Œæ— æœåŠ¡å™¨ã€‚</p>

    <div class="card" id="liveCompare">
      <div class="row">
        <div>
          <label for="left">ç‰ˆæœ¬ Aï¼ˆæ—§ / åŸºçº¿ï¼‰</label>
          <textarea id="left" placeholder="æŠŠç¬¬ä¸€æ¬¡ç‰ˆæœ¬ç²˜è´´åˆ°è¿™é‡Œï¼Œæˆ–ä»ä¸‹æ–¹ç‰ˆæœ¬åº“é€‰æ‹©"></textarea>
        </div>
        <div>
          <label for="right">ç‰ˆæœ¬ Bï¼ˆæ–° / å½“å‰ï¼‰</label>
          <textarea id="right" placeholder="æŠŠç¬¬10æ¬¡ç‰ˆæœ¬ç²˜è´´åˆ°è¿™é‡Œï¼Œæˆ–ä»ä¸‹æ–¹ç‰ˆæœ¬åº“é€‰æ‹©"></textarea>
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button class="btn primary" id="btnCompare">å¯¹æ¯”</button>
        <button class="btn" id="btnSwap" title="å·¦å³äº’æ¢">å·¦å³äº’æ¢</button>
        <span class="muted">ç²’åº¦ï¼š</span>
        <select id="granularity">
          <option value="words" selected>è¯çº§</option>
          <option value="chars">å­—ç¬¦çº§</option>
          <option value="lines">è¡Œçº§</option>
        </select>
        <label><input type="checkbox" id="ignoreCase" /> å¿½ç•¥å¤§å°å†™</label>
        <label><input type="checkbox" id="ignoreWhitespace" /> å¿½ç•¥ç©ºç™½</label>
      </div>

      <div class="section-title">å¯¹æ¯”ç»“æœ</div>
      <div class="summary" id="summary">
        <span class="pill">æ–°å¢ï¼š<b id="addedCount">0</b></span>
        <span class="pill">åˆ é™¤ï¼š<b id="removedCount">0</b></span>
        <span class="pill">å˜æ›´å—ï¼š<b id="blockCount">0</b></span>
      </div>
      <div class="diff" id="diff"></div>
    </div>

    <div class="card" style="margin-top:16px" id="versionLib">
      <div class="section-title">ç‰ˆæœ¬åº“ï¼ˆä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰</div>
      <div class="grid-3">
        <div>
          <label for="verName">ä¿å­˜å½“å‰å³ä¾§æ–‡æœ¬ä¸ºç‰ˆæœ¬ï¼ˆå¯é€‰å‘½åï¼‰</label>
          <div class="toolbar">
            <input type="text" id="verName" placeholder="ä¾‹å¦‚ï¼šç¬¬10æ¬¡ä¿®æ”¹" />
            <button class="btn" id="btnSave">ä¿å­˜ä¸ºç‰ˆæœ¬</button>
          </div>
          <p class="help">æç¤ºï¼šä¿å­˜æ—¶ä¼šè®°å½•æ—¶é—´æˆ³ä¸æ–‡æœ¬å†…å®¹ã€‚</p>
        </div>
        <div>
          <label>é€‰æ‹©ç‰ˆæœ¬ A</label>
          <select id="selectA"></select>
          <div class="toolbar" style="margin-top:6px">
            <button class="btn" id="loadAtoLeft">è½½å…¥åˆ°å·¦ä¾§</button>
          </div>
        </div>
        <div>
          <label>é€‰æ‹©ç‰ˆæœ¬ B</label>
          <select id="selectB"></select>
          <div class="toolbar" style="margin-top:6px">
            <button class="btn" id="loadBtoRight">è½½å…¥åˆ°å³ä¾§</button>
          </div>
        </div>
      </div>
      <hr class="hr" />
      <div class="toolbar">
        <button class="btn" id="btnCompareSelected">ç›´æ¥å¯¹æ¯”æ‰€é€‰ç‰ˆæœ¬ A ä¸ B</button>
        <button class="btn ghost" id="btnExport">å¯¼å‡ºå…¨éƒ¨ç‰ˆæœ¬ï¼ˆJSONï¼‰</button>
        <input type="file" id="fileImport" accept="application/json" style="display:none" />
        <button class="btn ghost" id="btnImport">å¯¼å…¥ç‰ˆæœ¬åº“</button>
        <button class="btn" id="btnClear" title="ä»…æ¸…ç©ºç‰ˆæœ¬åº“ï¼Œä¸å½±å“ä¸Šé¢æ–‡æœ¬æ¡†">æ¸…ç©ºç‰ˆæœ¬åº“</button>
      </div>
      <p class="help">ä½ å¯ä»¥æŠŠâ€œç¬¬ä¸€æ¬¡å†…å®¹â€ä¿å­˜ä¸ºç‰ˆæœ¬ Aï¼Œâ€œç¬¬10æ¬¡å†…å®¹â€ä¿å­˜ä¸ºç‰ˆæœ¬ Bï¼Œç„¶åç‚¹å‡»â€œç›´æ¥å¯¹æ¯”â€ã€‚</p>
    </div>

    <div class="footer">âš ï¸ æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ã€‚æ¢ç”µè„‘æˆ–æ¸…ç†æµè§ˆå™¨æ•°æ®ä¼šä¸¢å¤±ï¼Œå»ºè®®ä¸å®šæœŸâ€œå¯¼å‡º JSONâ€åšå¤‡ä»½ã€‚</div>
  </div>

<script>
(function(){
  const LS_KEY = 'simple_text_versions_v1';
  const $ = (id) => document.getElementById(id);
  const left = $('left');
  const right = $('right');
  const diffBox = $('diff');
  const addedCountEl = $('addedCount');
  const removedCountEl = $('removedCount');
  const blockCountEl = $('blockCount');
  const granularity = $('granularity');
  const ignoreCase = $('ignoreCase');
  const ignoreWhitespace = $('ignoreWhitespace');
  const selectA = $('selectA');
  const selectB = $('selectB');

  function fmtTime(ts){
    const d = new Date(ts);
    const pad = (n) => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function loadStore(){
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
    catch { return []; }
  }
  function saveStore(list){
    localStorage.setItem(LS_KEY, JSON.stringify(list));
    refreshSelects();
  }
  function refreshSelects(){
    const list = loadStore();
    function fill(sel){
      sel.innerHTML = '';
      if(list.length === 0){
        const o = document.createElement('option');
        o.textContent = 'ï¼ˆæš‚æ— ç‰ˆæœ¬ï¼‰'; o.value = '';
        sel.appendChild(o); return;
      }
      list.slice().reverse().forEach(v => {
        const o = document.createElement('option');
        o.value = v.id;
        o.textContent = `${v.title || 'æœªå‘½å'} Â· ${fmtTime(v.ts)}`;
        sel.appendChild(o);
      });
    }
    fill(selectA); fill(selectB);
  }

  function getVersionById(id){
    if(!id) return null;
    const list = loadStore();
    return list.find(v=>v.id===id) || null;
  }

  function tokenizeWords(str){
    return str.split(/(\s+)/); // ä¿ç•™ç©ºç™½ç”¨äºæ¸²æŸ“
  }

  function computeDiff(a, b){
    const opts = { ignoreCase: !!ignoreCase.checked, ignoreWhitespace: !!ignoreWhitespace.checked };
    let parts;
    switch(granularity.value){
      case 'lines': parts = Diff.diffLines(a,b,opts); break;
      case 'chars': parts = Diff.diffChars(a,b,opts); break;
      default: // words
        // ä½¿ç”¨ diffWords ä¿ç•™ä¸­æ–‡ä¸è‹±æ–‡è¯çš„å¯è¯»æ€§
        parts = Diff.diffWords(a,b,opts);
    }
    return parts;
  }

  function render(parts){
    let added=0, removed=0, blocks=0;
    const frag = document.createDocumentFragment();
    parts.forEach(p => {
      const span = document.createElement('span');
      if(p.added){ span.className='added'; added += p.value.length; blocks++; }
      else if(p.removed){ span.className='removed'; removed += p.value.length; blocks++; }
      else { span.className='unchanged'; }
      span.textContent = p.value;
      frag.appendChild(span);
    });
    diffBox.innerHTML = '';
    diffBox.appendChild(frag);
    addedCountEl.textContent = added;
    removedCountEl.textContent = removed;
    blockCountEl.textContent = parts.filter(p=>p.added||p.removed).length;
  }

  $('btnCompare').addEventListener('click', () => {
    render(computeDiff(left.value, right.value));
  });
  $('btnSwap').addEventListener('click', () => {
    const tmp = left.value; left.value = right.value; right.value = tmp;
  });

  $('btnSave').addEventListener('click', () => {
    const content = right.value;
    if(!content){ alert('å³ä¾§æ–‡æœ¬ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜'); return; }
    const name = $('verName').value.trim();
    const list = loadStore();
    const id = Math.random().toString(36).slice(2);
    list.push({ id, title: name || `ç‰ˆæœ¬ ${list.length+1}`, content, ts: Date.now() });
    saveStore(list);
    $('verName').value = '';
    alert('å·²ä¿å­˜åˆ°ç‰ˆæœ¬åº“ï¼ˆä¿å­˜çš„æ˜¯å³ä¾§æ–‡æœ¬ï¼‰');
  });

  $('loadAtoLeft').addEventListener('click', () => {
    const v = getVersionById(selectA.value); if(v){ left.value = v.content; }
  });
  $('loadBtoRight').addEventListener('click', () => {
    const v = getVersionById(selectB.value); if(v){ right.value = v.content; }
  });
  $('btnCompareSelected').addEventListener('click', () => {
    const va = getVersionById(selectA.value);
    const vb = getVersionById(selectB.value);
    if(!va || !vb){ alert('è¯·é€‰æ‹©ä¸¤ä¸ªæœ‰æ•ˆç‰ˆæœ¬'); return; }
    left.value = va.content; right.value = vb.content;
    render(computeDiff(left.value, right.value));
  });

  $('btnClear').addEventListener('click', () => {
    if(confirm('ç¡®å®šæ¸…ç©ºæœ¬åœ°ç‰ˆæœ¬åº“ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')){
      saveStore([]);
    }
  });

  $('btnExport').addEventListener('click', () => {
    const data = JSON.stringify(loadStore(), null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'versions-backup.json'; a.click();
    URL.revokeObjectURL(url);
  });

  $('btnImport').addEventListener('click', () => $('fileImport').click());
  $('fileImport').addEventListener('change', (e) => {
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const list = JSON.parse(reader.result);
        if(!Array.isArray(list)) throw new Error('æ ¼å¼ä¸æ­£ç¡®');
        saveStore(list);
        alert('ç‰ˆæœ¬åº“å·²å¯¼å…¥');
      } catch(err){
        alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
      }
    };
    reader.readAsText(f);
  });

  // åˆå§‹æ¸²æŸ“
  refreshSelects();
})();
</script>
</body>
</html>